# Develop build spec to create build artifacts, sync to develop test environment
# Typically runs automatically on commit to develop branch
version: 0.2
env:
  variables:
    environment: "Develop"
    S3Bucket: "s3://da-codepipeline-bucket"
    SiteBucket: "s3://da-gatsby-bucket"
    BRAND_NAME_LONG: "SOCKET"
    BRAND_NAME_SHORT: "SOCKET"
    SITE_URL: "https://localhost:8000"
    GTM_ID: "GTM-T4ZQZNK"
phases:
    install:
      runtime-versions:
        nodejs: 10
      commands:
            - 'touch .yarnignore'
            - 'yarn global add gatsby-cli'
    pre_build:
        commands:
            - echo Installing source yarn dependencies...
            - 'yarn install'
    build:
        commands:
            - echo Build started on `date`
            - 'cd ./packages/apps/storybook'
            - 'yarn build'
            - 'aws s3 sync "./build" $S3Bucket/build --delete --acl "public-read"'
            - 'aws s3 sync "./build" $SiteBucket/build --delete --acl "public-read"'
            - 'cd ../www'
            - 'yarn build'
    post_build:
        commands:
            - 'aws s3 sync "./public" $S3Bucket/public --delete --acl "public-read"'
            - 'aws s3 sync "./public" $SiteBucket --delete --acl "public-read"'
artifacts:
    files:
        - '**/*'
